<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blackjack Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: black;
      color: #00ff00;
      font-family: monospace;
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
    }
    .card {
      font-family: monospace;
      white-space: pre;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      width: auto !important;
      height: auto !important;
    }
    .suit-red {
      color: #ff5555;
    }
    .suit-black {
      color: #55ff55;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-4 text-center">♣ BLACKJACK ♠</h1>
    
    <div id="mainMenu">
      <div class="text-center text-xl mb-4" id="playerInfo"></div>
      <button id="randomBtn" class="w-full bg-black border border-green-500 text-green-500 px-4 py-2 mb-4">[1] Random Opponent</button>
      <input type="text" id="roomInput" class="w-full bg-black border border-green-500 text-green-500 px-4 py-2 mb-2" placeholder="Room Name">
      <button id="createBtn" class="w-full bg-black border border-green-500 text-green-500 px-4 py-2 mb-2">[C] Create Room</button>
      <button id="joinBtn" class="w-full bg-black border border-green-500 text-green-500 px-4 py-2 mb-4">[J] Join Room</button>
      <div id="errorMsg" class="text-red-400 text-center mt-2"></div>
    </div>

    <div id="gameUI" class="hidden">
      <div class="text-center text-lg mb-4" id="namesAndScore"></div>
      <div id="handInfo" class="whitespace-pre mb-4 text-sm"></div>
      <div id="actionBtns" class="flex space-x-2 justify-center mb-4 hidden">
        <button id="hitBtn" class="bg-black border border-green-500 text-green-500 px-4 py-2">[H] Hit</button>
        <button id="standBtn" class="bg-black border border-green-500 text-green-500 px-4 py-2">[S] Stand</button>
      </div>
      <div id="gameStatus" class="text-center text-sm mb-4"></div>
      <button id="menuBtn" class="hidden w-full bg-black border border-green-500 text-green-500 px-4 py-2">Main Menu</button>
    </div>
  </div>

  <script>
    const API = "https://sortalost.is-a.dev/bj_api";
    let playerName = "", playerId = "", room = "";
    let score = { wins: 0, games: 0 };
    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function getWords(n = 2) {
      const url = "https://sortalost.github.io/sources/files/words.txt";
      try {
        const res = await fetch(url);
        const words = (await res.text()).split("\n");
        const chosen = [];
        while (chosen.length < n) {
          const word = words[Math.floor(Math.random() * words.length)].trim();
          if (word && !chosen.includes(word)) chosen.push(word);
        }
        return chosen.join(" ");
      } catch {
        return "Player" + Math.floor(Math.random() * 999);
      }
    }

    function renderCard(card) {
      if (!card) return "";
      const rank = card.slice(0, -1);
      const suit = card.slice(-1);
      return [
        "┌───────┐",
        `│${rank.padEnd(2)}     │`,
        `│   ${suit}   │`,
        `│     ${rank.padStart(2)}│`,
        "└───────┘"
      ];
    }

    function renderHand(hand, label) {
      const lines = hand.map(renderCard);
      const joined = Array.from({ length: 5 }, (_, i) =>
        lines.map(line => line[i]).join("   ")
      );
      return `${label}:\n${joined.join("\n")}`;
    }

    async function fetchState() {
      const res = await fetch(`${API}/state?room=${room}&player=${playerId}`);
      return await res.json();
    }

    async function showState() {
      const state = await fetchState();
      document.getElementById("namesAndScore").textContent =
        `${state.your_name} vs ${state.opponent_name} | Score: ${score.wins}/${score.games}`;
      
      document.getElementById("handInfo").textContent =
        renderHand(state.your_hand, "Your Hand") + `\n\nHand Value: ${state.your_value}`;

      if (state.status === "finished") {
        document.getElementById("handInfo").textContent +=
          `\n\nOpponent's Hand:\n` + renderHand(state.opponent_hand, "Opponent") +
          `\n\nOpponent Value: ${state.opponent_value}`;

        if (state.winner === playerId) {
          document.getElementById("gameStatus").textContent = "You Win!";
          score.wins++;
        } else if (state.winner === "draw") {
          document.getElementById("gameStatus").textContent = "Draw!";
        } else {
          document.getElementById("gameStatus").textContent = "You Lose!";
        }

        score.games++;
        document.getElementById("actionBtns").classList.add("hidden");
        document.getElementById("menuBtn").classList.remove("hidden");
        return true;
      }

      if (state.turn === playerId) {
        document.getElementById("gameStatus").textContent = "Your Turn!";
        document.getElementById("actionBtns").classList.remove("hidden");
      } else {
        document.getElementById("gameStatus").textContent = "Waiting for Opponent...";
        document.getElementById("actionBtns").classList.add("hidden");
      }

      return false;
    }

    async function startGameLoop() {
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("gameUI").classList.remove("hidden");

      while (true) {
        const done = await showState();
        if (done) break;
        await delay(1500);
      }
    }

    async function postRoom(endpoint) {
      const res = await fetch(`${API}/${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room, name: playerName })
      });
      return res;
    }

    async function joinRoom(isCreate) {
      const route = isCreate ? "create_room" : "join_room";
      const res = await postRoom(route);
      if (!res.ok) {
        const msg = (await res.json()).error || "Room error.";
        document.getElementById("errorMsg").textContent = msg;
        return;
      }

      playerId = isCreate ? "p1" : "p2";
      document.getElementById("errorMsg").textContent = "";
      if (isCreate) {
        while ((await fetchState()).status === "waiting") {
          document.getElementById("gameStatus").textContent = "Waiting for opponent to join...";
          await delay(1500);
        }
      }
      startGameLoop();
    }

    async function randomMatch() {
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("gameUI").classList.remove("hidden");
      document.getElementById("gameStatus").textContent = "Searching for opponent...";

      while (true) {
        const res = await fetch(`${API}/random_match`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName })
        });
        const data = await res.json();
        if (data.room) {
          room = data.room;
          playerId = data.player;
          break;
        }
        await delay(1000);
      }
      startGameLoop();
    }

    function setupListeners() {
      document.getElementById("randomBtn").onclick = randomMatch;
      document.getElementById("createBtn").onclick = () => {
        room = document.getElementById("roomInput").value.trim();
        if (room) joinRoom(true);
      };
      document.getElementById("joinBtn").onclick = () => {
        room = document.getElementById("roomInput").value.trim();
        if (room) joinRoom(false);
      };
      document.getElementById("hitBtn").onclick = async () => {
        await fetch(`${API}/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room, player: playerId, move: "hit" })
        });
        await showState();
      };
      document.getElementById("standBtn").onclick = async () => {
        await fetch(`${API}/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room, player: playerId, move: "stand" })
        });
        await showState();
      };
      document.getElementById("menuBtn").onclick = () => {
        document.getElementById("mainMenu").classList.remove("hidden");
        document.getElementById("gameUI").classList.add("hidden");
        document.getElementById("menuBtn").classList.add("hidden");
        document.getElementById("gameStatus").textContent = "";
      };
    }

    async function init() {
      playerName = await getWords();
      document.getElementById("playerInfo").textContent = `Welcome, ${playerName}`;
      setupListeners();
    }

    init();
  </script>
</body>
</html>
